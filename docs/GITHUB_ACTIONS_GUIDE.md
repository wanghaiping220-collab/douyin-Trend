# GitHub Actions 部署完整指南

本指南将详细说明如何使用 GitHub Actions 自动运行抖音热榜抓取任务。

## 为什么选择 GitHub Actions？

- ✅ **完全免费** - GitHub 为公开仓库提供无限制的 Actions 运行时间
- ✅ **无需服务器** - 不需要购买或维护服务器
- ✅ **稳定可靠** - GitHub 的基础设施保证稳定性
- ✅ **易于管理** - 可视化的执行日志和管理界面
- ✅ **灵活配置** - 支持多种触发方式和自定义频率

## 快速开始（5分钟完成）

### 步骤 1：Fork 项目

1. 访问本项目的 GitHub 页面
2. 点击右上角的 **Fork** 按钮
3. 等待 Fork 完成

### 步骤 2：配置飞书 Webhook URL

#### 2.1 获取飞书 Webhook URL

1. 打开飞书，进入想要接收消息的群聊
2. 点击群聊右上角的 **设置** 按钮（齿轮图标）
3. 选择 **群机器人** → **添加机器人**
4. 选择 **自定义机器人**
5. 设置机器人信息：
   - 名称：抖音热榜推送（或其他你喜欢的名称）
   - 描述：定时推送抖音热榜（可选）
6. 点击 **添加**
7. **复制生成的 Webhook URL**（格式类似：`https://open.feishu.cn/open-apis/bot/v2/hook/xxx`）

#### 2.2 在 GitHub 中配置 Secret

1. 进入你 Fork 的仓库
2. 点击顶部菜单的 **Settings**（设置）
3. 在左侧菜单中找到 **Secrets and variables** → **Actions**
4. 点击 **New repository secret** 按钮
5. 填写以下信息：
   - **Name**: `FEISHU_WEBHOOK_URL`（必须完全一致）
   - **Secret**: 粘贴刚才复制的飞书 Webhook URL
6. 点击 **Add secret** 保存

### 步骤 3：启用 GitHub Actions

1. 进入仓库的 **Actions** 标签页
2. 如果看到提示 "Workflows aren't being run on this forked repository"
3. 点击绿色按钮 **I understand my workflows, go ahead and enable them**
4. 工作流将自动启用

### 步骤 4：测试运行

#### 手动触发测试

1. 在 **Actions** 标签页
2. 在左侧选择 **抓取抖音热榜并推送到飞书** 工作流
3. 点击右侧的 **Run workflow** 下拉按钮
4. 点击绿色的 **Run workflow** 按钮
5. 等待几秒钟，页面会出现新的工作流运行
6. 点击进入查看详细日志

#### 查看执行结果

- ✅ 绿色对勾：执行成功，检查飞书群是否收到消息
- ❌ 红色叉号：执行失败，点击查看详细日志
- 🟡 黄色圆点：正在执行中

## 自定义执行频率

### 方法一：使用预设模板（推荐新手）

编辑 `.github/workflows/scrape-and-notify.yml` 文件，在 `schedule` 部分选择以下模板之一：

#### 每小时一次（默认）
```yaml
schedule:
  - cron: '0 * * * *'
```

#### 每2小时一次
```yaml
schedule:
  - cron: '0 */2 * * *'
```

#### 每3小时一次
```yaml
schedule:
  - cron: '0 */3 * * *'
```

#### 每天3次（早、中、晚）
```yaml
schedule:
  # 北京时间 9:00（UTC 1:00）
  - cron: '0 1 * * *'
  # 北京时间 12:00（UTC 4:00）
  - cron: '0 4 * * *'
  # 北京时间 18:00（UTC 10:00）
  - cron: '0 10 * * *'
```

#### 工作日每天早上
```yaml
schedule:
  # 工作日（周一到周五）北京时间 9:00
  - cron: '0 1 * * 1-5'
```

### 方法二：自定义 Cron 表达式

#### Cron 表达式格式

```
┌───────────── 分钟 (0 - 59)
│ ┌───────────── 小时 (0 - 23)
│ │ ┌───────────── 日期 (1 - 31)
│ │ │ ┌───────────── 月份 (1 - 12)
│ │ │ │ ┌───────────── 星期 (0 - 6) (0 = 周日)
│ │ │ │ │
* * * * *
```

#### 常用符号说明

- `*` : 匹配所有值
- `*/n` : 每 n 个单位
- `n,m` : 在 n 和 m 时刻
- `n-m` : 从 n 到 m

#### 示例

| Cron 表达式 | 说明 | UTC 时间 | 北京时间（UTC+8） |
|------------|------|----------|-----------------|
| `0 * * * *` | 每小时 | 每小时的第0分 | 每小时的第0分 |
| `30 * * * *` | 每小时的第30分 | 每小时的第30分 | 每小时的第30分 |
| `0 */2 * * *` | 每2小时 | 0,2,4,6,8,10,12,14,16,18,20,22 | 8,10,12,14,16,18,20,22,0,2,4,6 |
| `0 0 * * *` | 每天一次 | UTC 0点 | 北京时间 8点 |
| `0 1 * * *` | 每天一次 | UTC 1点 | 北京时间 9点 |
| `0 1,13 * * *` | 每天两次 | UTC 1点和13点 | 北京时间 9点和21点 |
| `0 1 * * 1` | 每周一 | UTC 1点 | 北京时间周一 9点 |
| `0 1 1 * *` | 每月1号 | UTC 1点 | 北京时间1号 9点 |

### 方法三：使用在线工具生成

推荐使用以下在线工具：

1. **Crontab Guru** - https://crontab.guru/
   - 输入 cron 表达式，立即看到执行时间说明
   - 简单直观，适合新手

2. **Crontab Generator** - https://crontab-generator.org/
   - 通过图形界面选择时间
   - 自动生成 cron 表达式

### 时区转换表（北京时间 ↔ UTC）

GitHub Actions 使用 **UTC 时间**，需要转换：

| 北京时间 | UTC 时间 | Cron 小时部分 |
|---------|---------|--------------|
| 00:00 | 前一天 16:00 | 16 |
| 01:00 | 前一天 17:00 | 17 |
| 02:00 | 前一天 18:00 | 18 |
| 03:00 | 前一天 19:00 | 19 |
| 04:00 | 前一天 20:00 | 20 |
| 05:00 | 前一天 21:00 | 21 |
| 06:00 | 前一天 22:00 | 22 |
| 07:00 | 前一天 23:00 | 23 |
| 08:00 | 00:00 | 0 |
| 09:00 | 01:00 | 1 |
| 10:00 | 02:00 | 2 |
| 11:00 | 03:00 | 3 |
| 12:00 | 04:00 | 4 |
| 13:00 | 05:00 | 5 |
| 14:00 | 06:00 | 6 |
| 15:00 | 07:00 | 7 |
| 16:00 | 08:00 | 8 |
| 17:00 | 09:00 | 9 |
| 18:00 | 10:00 | 10 |
| 19:00 | 11:00 | 11 |
| 20:00 | 12:00 | 12 |
| 21:00 | 13:00 | 13 |
| 22:00 | 14:00 | 14 |
| 23:00 | 15:00 | 15 |

**快速计算公式：UTC 时间 = 北京时间 - 8 小时**

### 修改频率后如何生效？

1. 编辑 `.github/workflows/scrape-and-notify.yml` 文件
2. 修改 `schedule` 部分的 `cron` 表达式
3. 提交更改（Commit）并推送（Push）
4. 新的频率将在下次执行时生效
5. 也可以手动触发测试

## 常见问题排查

### 问题 1：没有收到飞书消息

**排查步骤：**

1. 检查 Actions 执行状态是否成功（绿色对勾）
2. 点击进入工作流运行详情，查看日志
3. 确认日志中显示 "消息发送成功"
4. 检查飞书 Webhook URL 是否正确
5. 确认飞书机器人是否被移除或禁用

**解决方法：**

- 重新获取飞书 Webhook URL 并更新 Secret
- 在 Actions 页面手动触发测试
- 查看详细日志中的错误信息

### 问题 2：工作流没有自动执行

**可能原因：**

1. Fork 的仓库默认禁用了 Actions
2. Cron 时间还没到
3. 仓库长期无活动被 GitHub 暂停

**解决方法：**

- 确认已启用 Actions（参考步骤 3）
- 检查 cron 表达式是否正确
- GitHub 对超过 60 天无活动的仓库会暂停 Actions，进行一次提交即可恢复

### 问题 3：执行失败，显示红色叉号

**排查步骤：**

1. 点击进入失败的工作流运行
2. 查看红色叉号所在的步骤
3. 展开查看详细错误信息

**常见错误：**

- `FEISHU_WEBHOOK_URL not found`: Secret 未配置或名称错误
- `HTTP 404/403`: Webhook URL 无效或已失效
- `Timeout`: 网络连接超时，稍后重试

### 问题 4：如何查看历史执行记录？

1. 进入仓库的 **Actions** 标签页
2. 左侧选择工作流
3. 右侧显示所有执行记录，包括：
   - 执行时间
   - 执行状态（成功/失败/进行中）
   - 触发方式（定时/手动/API）
4. 点击任意记录可查看详细日志

### 问题 5：想要暂停自动执行怎么办？

**方法一：禁用工作流**

1. 进入 Actions 标签页
2. 选择工作流
3. 点击右上角的 **···** 按钮
4. 选择 **Disable workflow**

**方法二：删除 schedule 配置**

编辑 `.github/workflows/scrape-and-notify.yml`，注释掉或删除 `schedule` 部分。

### 问题 6：想要临时测试怎么办？

使用 **手动触发** 功能：

1. 进入 Actions 标签页
2. 选择工作流
3. 点击 **Run workflow** 按钮
4. 可以选择分支和输入参数
5. 点击绿色的 **Run workflow** 按钮

## 高级配置

### 1. 修改热榜数量

编辑 `.github/workflows/scrape-and-notify.yml`，在 `env` 部分添加：

```yaml
env:
  FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
  HOT_LIST_LIMIT: 30  # 修改为你想要的数量
```

### 2. 配置多个飞书群

创建多个 Secret：
- `FEISHU_WEBHOOK_URL_GROUP1`
- `FEISHU_WEBHOOK_URL_GROUP2`

复制工作流文件，创建多个不同的工作流。

### 3. 添加通知失败重试

编辑 `run_once.py`，在失败时添加重试逻辑（已在代码中实现）。

### 4. 自定义消息格式

编辑 `feishu_notifier.py`，修改 `send_interactive_message` 方法中的卡片样式。

## 成本说明

GitHub Actions 免费额度：

| 仓库类型 | 免费额度 |
|---------|---------|
| 公开仓库 | 无限制 |
| 私有仓库 | 2000 分钟/月 |

本项目每次执行约需 **30-60 秒**，即使每小时执行一次，一个月也只需要约 **30-50 分钟**，远低于免费额度。

## 总结

使用 GitHub Actions 部署的优势：

✅ 零成本运行
✅ 无需维护服务器
✅ 稳定可靠
✅ 易于配置和管理
✅ 可视化日志
✅ 灵活的触发方式

适合个人使用和轻量级定时任务！
