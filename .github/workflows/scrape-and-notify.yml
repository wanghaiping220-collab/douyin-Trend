name: 抓取抖音热榜并推送到飞书

on:
  # 定时触发 - 默认每小时执行一次 (可自定义)
  schedule:
    # 每小时的第0分钟执行
    - cron: '0 * * * *'
    # 其他示例：
    # - cron: '0 */2 * * *'    # 每2小时
    # - cron: '0 */3 * * *'    # 每3小时
    # - cron: '0 */6 * * *'    # 每6小时
    # - cron: '0 9,12,18 * * *'  # 每天9点、12点、18点
    # - cron: '0 9 * * *'      # 每天9点
    # - cron: '30 8 * * 1-5'   # 工作日每天8:30

  # 支持手动触发
  workflow_dispatch:
    inputs:
      limit:
        description: '抓取热榜数量'
        required: false
        default: '20'
        type: number

  # 支持通过 API 触发
  repository_dispatch:
    types: [scrape-douyin-hot]

# 设置权限
permissions:
  contents: read

jobs:
  scrape-and-notify:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 运行抓取任务
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          LOG_LEVEL: INFO
        run: |
          python run_once.py

      - name: 上传日志（如果失败）
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs
          path: '*.log'
          retention-days: 7
